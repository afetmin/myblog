---
title: å…³äºä¸­é—´ä»¶
date: 2021-09-19 09:51:18
tags: node
categories: è¿›é˜¶
---

# ä¸­é—´ä»¶

ä½¿ç”¨ node æ„å»º web åº”ç”¨æ—¶ï¼Œå¹¶ä¸å•å•å“åº”ä¸€ä¸ªç®€å•çš„ hello worldï¼Œåœ¨ä¸€ä¸ªå®é™…çš„ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®¸ä¼šåšè¿™äº›ï¼š

- è¯·æ±‚æ–¹æ³•çš„åˆ¤æ–­ã€‚
- URL çš„è·¯å¾„è§£æã€‚
- URL ä¸­æŸ¥è¯¢å­—ç¬¦ä¸²è§£æã€‚
- Cookie çš„è§£æã€‚
- Basic è®¤è¯ã€‚
- è¡¨å•æ•°æ®çš„è§£æã€‚
- ä»»æ„æ ¼å¼æ–‡ä»¶çš„ä¸Šä¼ å¤„ç†ã€‚

è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ä¸­éœ€è¦å¤„ç†å¾ˆå¤šçš„ç»†èŠ‚ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥éƒ½å†™åœ¨ä¸€èµ·ï¼Œä½†è¿™æ ·ä»£ç çš„è€¦åˆç¨‹åº¦å¤ªé«˜äº†ï¼Œè€Œä¸”ä»¥åç»´æŠ¤èµ·æ¥ä¹Ÿä»¤äººå¤´å¤§ã€‚

ä¸ºæ­¤å¼•å…¥**ä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰**æ¥ç®€åŒ–å’Œéš”ç¦»è¿™äº›åŸºç¡€è®¾æ–½ä¸ä¸šåŠ¡é€»è¾‘ä¹‹é—´çš„ç»†èŠ‚ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿå…³æ³¨åœ¨ä¸šåŠ¡çš„å¼€å‘ä¸Šï¼Œä»¥è¾¾åˆ°æå‡å¼€å‘æ•ˆç‡çš„ç›®çš„ã€‚

ç†è§£ä¸­é—´ä»¶çš„æœ€ç®€å•çš„æ–¹å¼æ˜¯å®ç°ä¸€ä¸ªåŸºç¡€çš„ä¸­é—´ä»¶æ¨¡å¼ï¼Œä¸€ä¸ªä¸­é—´ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚

ä¸€ä¸ªç®€å•çš„ä¸­é—´ä»¶æ¨¡å¼éœ€è¦ä¸€ä¸ª use æ–¹æ³•æ¥è¿›è¡Œä¸­é—´ä»¶çš„æ³¨å†Œï¼Œéœ€è¦ä¸€ä¸ª run æ¥æ‰§è¡Œè¿™äº›æ³¨å†Œçš„ä¸­é—´ä»¶

```jsx
const app = {
  fns: [],
  callback(ctx) {
    console.log(ctx)
  },
  use(fn) {
    this.fns.push(fn)
  },
  run(ctx) {
    let index = 0
    const next = () => {
      index++
    }
    this.fns.forEach((fn, idx) => {
      if (index === idx) fn(ctx, next)
    })
    index === this.fns.length && this.callback(ctx)
  },
}
```

ä½¿ç”¨ä¸€ä¸‹ï¼š

```jsx
app.use((ctx, next) => {
  ctx.name = "ranxiu"
  next()
})

app.use((ctx, next) => {
  ctx.gender = "girl"
  next()
})

app.run({})
// æ‰“å°ï¼š{name:"ranxiu",gender:"girl"}
```

å…³äº run å‡½æ•°è¿˜æœ‰æ›´åŠ ä¼˜é›…çš„å†™æ³•ï¼š

```jsx
function run(ctx, stack) {
  const next = () => {
    const middleware = stack.shift()
    if (middleware) {
      middleware(ctx, next) // é€’å½’è°ƒç”¨
    }
  }
  next()
}
```

å†æ¥çœ‹çœ‹ koa-compose çš„ä¸­é—´ä»¶ï¼š

```jsx
function compose(middleware) {
  // æå‰åˆ¤æ–­ä¸­é—´ä»¶ç±»å‹,é˜²æ­¢åç»­é”™è¯¯
  if (!Array.isArray(middleware))
    throw new TypeError("Middleware stack must be an array!")
  for (const fn of middleware) {
    // ä¸­é—´ä»¶å¿…é¡»ä¸ºå‡½æ•°ç±»å‹
    if (typeof fn !== "function")
      throw new TypeError("Middleware must be composed of functions!")
  }
  return function (context, next) {
    // é‡‡ç”¨é—­åŒ…å°†ç´¢å¼•ç¼“å­˜,æ¥å®ç°è°ƒç”¨è®¡æ•°
    let index = -1
    return dispatch(0)
    function dispatch(i) {
      // é˜²æ­¢next()æ–¹æ³•é‡å¤è°ƒç”¨
      if (i <= index)
        return Promise.reject(new Error("next() called multiple times"))
      index = i
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      try {
        // åŒ…è£…next()è¿”å›å€¼ä¸ºPromiseå¯¹è±¡
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)))
      } catch (err) {
        // å¼‚å¸¸å¤„ç†
        return Promise.reject(err)
      }
    }
  }
}
```

ä¸¤ä¸ªå­—ï¼šä¼˜é›…ã€‚æœ‰æ—¶ä¸å¾—ä¸æ„Ÿæ…¨äººå’Œäººçš„å·®è·æœ‰æ—¶æ¯”äººå’Œç‹—çš„å·®è·è¿˜å¤§ã€‚

æ‹¿è¿™ä¸ª ğŸŒ° æ¥è¯´ï¼š

```jsx
function wait(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms || 1))
}

const arr = []
const stack = []

// type Middleware<T> = (context: T, next: Koa.Next) => any;
stack.push(async (context, next) => {
  arr.push(1)
  await wait(1)
  await next()
  await wait(1)
  arr.push(6)
})

stack.push(async (context, next) => {
  arr.push(2)
  await wait(1)
  await next()
  await wait(1)
  arr.push(5)
})

stack.push(async (context, next) => {
  arr.push(3)
  await wait(1)
  await next()
  await wait(1)
  arr.push(4)
})

await compose(stack)({})
// arr = [1,2,3,4,5,6]
```

å½“ i ä¸º 3 æ—¶ï¼Œ

```jsx
let fn = middleware[i] //fn=undefined
if (i === middleware.length) fn = next
if (!fn) return Promise.resolve() //!fnä¸ºtrue
```

ç›´æ¥è¿”å› resolveï¼Œä¹‹åå°±æ‰§è¡Œ next()åé¢çš„å‡½æ•°

```jsx
stack.push(async (context, next) => {
  arr.push(3)
  await wait(1)
  await next()
  await wait(1)
  arr.push(4)
})
```

æ‰§è¡Œå®Œåè¿”å›ç¬¬äºŒä¸ª next() åé¢ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼ŒçŸ¥é“æ‰€æœ‰çš„ä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•ã€‚

è¿™ä¾¿æ˜¯ä¼—äººçš†çŸ¥çš„â€œæ´‹è‘±æ¨¡å‹â€ã€‚ä½ ä¹Ÿå¯ä»¥é€‰æ‹©åªæ·»åŠ å‰ç½®çš„å¤„ç†ï¼Œå°±æ˜¯ await next()å‰é¢çš„æ“ä½œ

ï¼Œæˆ–è€…åé¢çš„å¤„ç†ã€‚@æ´‹è‘±åˆ©ç”¨æ´‹è‘±æ¨¡å‹å®ç°äº†è®¾è®¡åœˆçš„å‰ç½®é€»è¾‘çš„åˆå§‹åŒ–ï¼Œæ´‹è‘± ğŸ‚ğŸºã€‚

æ¯ä¸ªä¸­é—´ä»¶è¶³å¤Ÿçš„å°è€Œç¾ï¼ŒèŒè´£å•ä¸€ï¼ŒåŒæ—¶å¤šä¸ªä¸­é—´ä»¶åˆå…·å¤‡è‰¯å¥½çš„é€»è¾‘æ‹“å±•æ€§å’Œå¯ç»„åˆæ€§ï¼Œå¹¶ä¸”æ˜“äºæµ‹è¯•ã€‚è¿™ä¸ªè®¾è®¡æ¨¡å¼çœŸæ˜¯å¤ªâ€œæ¼‚äº®â€äº†ã€‚
